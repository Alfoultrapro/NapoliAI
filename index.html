<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>NapoliAI</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#cce6ff;
  margin:0;
  height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  background:#004080;
  color:white;
  padding:22px;
  text-align:center;
  font-size:2.5em;
}
#chat{
  flex:1;
  padding:20px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
}
.msg{
  max-width:80%;
  padding:18px 22px;
  margin-bottom:14px;
  border-radius:22px;
  font-size:1.4em;
}
.user{
  background:#99ccff;
  color:#004080;
  align-self:flex-end;
}
.ai{
  background:#004080;
  color:white;
  align-self:flex-start;
}
.input-area{
  display:flex;
  gap:10px;
  padding:12px;
  border-top:2px solid #004080;
  background:#cce6ff;
}
input{
  flex:1;
  padding:16px;
  font-size:1.3em;
  border-radius:20px;
  border:2px solid #004080;
}
button{
  padding:16px 22px;
  font-size:1.2em;
  border-radius:20px;
  border:2px solid #004080;
  background:#004080;
  color:white;
}
</style>
</head>

<body>
<header>NapoliAI</header>

<div id="chat"></div>

<div class="input-area">
  <input id="input" placeholder="Scriveme...">
  <button onclick="send()">Invia</button>
  <button onclick="resetChat()">Reset</button>
</div>

<script src="https://js.puter.com/v2/"></script>
<script>
const chat=document.getElementById("chat");
const input=document.getElementById("input");

let longMemory = JSON.parse(localStorage.getItem("napoli_memory")) || {};

const systemPrompt = `
Si NapoliAI.
Parla SOLO in dialetto napoletano stretto.
Si naturale, amichevole e chiaro.
Usa 'a memoria si serve.
`;

let conversation=[{role:"system",content:systemPrompt}];

function saveMemory(){
  localStorage.setItem("napoli_memory", JSON.stringify(longMemory));
}

function render(){
  chat.innerHTML="";
  conversation.forEach(m=>{
    if(m.role==="system") return;
    const d=document.createElement("div");
    d.className="msg "+(m.role==="user"?"user":"ai");
    d.innerHTML=m.content;
    chat.appendChild(d);
  });
  chat.scrollTop=chat.scrollHeight;
}

async function send(){
  const text=input.value.trim();
  if(!text) return;
  input.value="";

  conversation.push({role:"user",content:text});
  render();

  const aiDiv=document.createElement("div");
  aiDiv.className="msg ai";
  chat.appendChild(aiDiv);

  const memTxt = Object.keys(longMemory).length
    ? "Memoria utente: "+JSON.stringify(longMemory)
    : "";

  const response = await puter.ai.chat(
    [
      { role:"system", content: systemPrompt + "\n" + memTxt },
      ...conversation.slice(-8)
    ],
    { model:"gpt-5-nano", stream:true }
  );

  let full="";
  for await(const part of response){
    if(part?.text){
      full+=part.text;
      aiDiv.innerHTML+=part.text;
    }
  }

  // esempio memoria automatica
  if(full.includes("me ricordo")){
    longMemory.ultima_info = full;
    saveMemory();
  }
}

function resetChat(){
  if(confirm("Vu√≤ cancella tutto?")){
    conversation=[{role:"system",content:systemPrompt}];
    longMemory={};
    saveMemory();
    render();
  }
}
</script>
</body>
</html>
