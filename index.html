<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>NapoliAI</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#cce6ff;
  margin:0;
  height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  background:#004080;
  color:white;
  padding:22px;
  text-align:center;
  font-size:2.4em;
}
#chat{
  flex:1;
  padding:20px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
}
.msg{
  max-width:80%;
  padding:16px 20px;
  margin-bottom:14px;
  border-radius:22px;
  font-size:1.3em;
}
.user{
  background:#99ccff;
  color:#004080;
  align-self:flex-end;
}
.ai{
  background:#004080;
  color:white;
  align-self:flex-start;
}
.time{
  font-size:0.7em;
  opacity:0.8;
  margin-top:6px;
}
.typing{
  font-style:italic;
  opacity:0.7;
}
.input-area{
  display:flex;
  gap:10px;
  padding:12px;
  border-top:2px solid #004080;
  background:#cce6ff;
}
input{
  flex:1;
  padding:16px;
  font-size:1.2em;
  border-radius:20px;
  border:2px solid #004080;
}
button{
  padding:16px 22px;
  font-size:1.1em;
  border-radius:20px;
  border:2px solid #004080;
  background:#004080;
  color:white;
}
button:disabled{
  opacity:0.5;
}
</style>
</head>

<body>
<header>NapoliAI</header>

<div id="chat"></div>

<div class="input-area">
  <input id="input" placeholder="Scriveme...">
  <button id="sendBtn" onclick="send()">Invia</button>
  <button onclick="resetChat()">Reset</button>
</div>

<script src="https://js.puter.com/v2/"></script>
<script>
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");

/* ðŸ’¾ STORAGE */
let conversation = JSON.parse(localStorage.getItem("napoli_chat")) || [];
let longMemory = JSON.parse(localStorage.getItem("napoli_memory")) || {};

const systemPrompt = `
Si NapoliAI.
Parla SOLO in dialetto napoletano stretto.
Si naturale, amichevole e chiaro.
`;

/* ðŸ•’ ORA */
function now(){
  return new Date().toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"});
}

/* ðŸ’¾ SAVE */
function saveAll(){
  localStorage.setItem("napoli_chat", JSON.stringify(conversation));
  localStorage.setItem("napoli_memory", JSON.stringify(longMemory));
}

/* ðŸŽ¨ RENDER */
function render(){
  chat.innerHTML="";
  conversation.forEach(m=>{
    const d=document.createElement("div");
    d.className="msg "+(m.role==="user"?"user":"ai");
    d.innerHTML = `
      ${m.content}
      <div class="time">${m.time}</div>
    `;
    chat.appendChild(d);
  });
  chat.scrollTop = chat.scrollHeight;
}

render();

/* ðŸ’¬ SEND */
async function send(){
  const text = input.value.trim();
  if(!text) return;
  input.value="";
  sendBtn.disabled=true;

  conversation.push({
    role:"user",
    content:text,
    time:now()
  });
  saveAll();
  render();

  const typingDiv=document.createElement("div");
  typingDiv.className="msg ai typing";
  typingDiv.textContent="NapoliAI sta scrivenn...";
  chat.appendChild(typingDiv);
  chat.scrollTop=chat.scrollHeight;

  const response = await puter.ai.chat(
    [
      { role:"system", content: systemPrompt },
      ...conversation.slice(-10).map(m=>({
        role: m.role==="user"?"user":"assistant",
        content: m.content
      }))
    ],
    { model:"gpt-4.1-nano", stream:true }
  );

  typingDiv.remove();

  let full="";
  const aiDiv=document.createElement("div");
  aiDiv.className="msg ai";
  chat.appendChild(aiDiv);

  for await(const part of response){
    if(part?.text){
      full+=part.text;
      aiDiv.innerHTML=full;
      chat.scrollTop=chat.scrollHeight;
    }
  }

  conversation.push({
    role:"assistant",
    content:full,
    time:now()
  });

  // ðŸ§  memoria automatica semplice
  if(full.toLowerCase().includes("me ricordo")){
    longMemory.ultima_info = full;
  }

  saveAll();
  render();
  sendBtn.disabled=false;
}

/* ðŸ§¹ RESET */
function resetChat(){
  if(confirm("VuÃ² cancella tutta 'a chat e 'a memoria?")){
    conversation=[];
    longMemory={};
    saveAll();
    render();
  }
}
</script>
</body>
</html>
