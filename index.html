<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>NapoliAI</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #cce6ff;
  margin: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

h1 {
  background: #004080;
  color: white;
  padding: 25px;
  margin: 0;
  text-align: center;
  font-size: 2.6em;
}

.chat-wrapper {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.msg {
  max-width: 80%;
  padding: 18px 24px;
  margin-bottom: 15px;
  border-radius: 25px;
  font-size: 1.5em;
  line-height: 1.5em;
}

.user {
  background: #99ccff;
  color: #004080;
  align-self: flex-end;
  border-bottom-right-radius: 0;
}

.ai {
  background: #004080;
  color: white;
  align-self: flex-start;
  border-bottom-left-radius: 0;
}

.msg img {
  max-width: 100%;
  border-radius: 20px;
  margin-top: 10px;
}

.input-area {
  display: flex;
  gap: 8px;
  padding: 12px;
  border-top: 2px solid #004080;
  background: #cce6ff;
}

input, select, button {
  font-size: 1.2em;
  padding: 14px;
  border-radius: 20px;
  border: 2px solid #004080;
}

button {
  background: #004080;
  color: white;
  cursor: pointer;
}

.progress {
  width: 100%;
  background: #99ccff;
  border-radius: 10px;
  overflow: hidden;
  margin-top: 10px;
}

.progress-bar {
  height: 14px;
  width: 0%;
  background: #00ccff;
  transition: width 0.3s;
}

@media(max-width:600px){
  .msg { font-size: 1.3em; }
  h1 { font-size: 2.2em; }
}
</style>
</head>

<body>

<h1>NapoliAI</h1>

<div class="chat-wrapper" id="chat"></div>

<div class="input-area">
  <select id="style">
    <option value="realistico">üì∑ Realistica</option>
    <option value="cartone animato">üé® Cartoon</option>
    <option value="anime">üëæ Anime</option>
  </select>
  <input id="msg" placeholder="Scrivi o descrivi 'a figura...">
  <button onclick="send()">Invia</button>
  <button onclick="sendImage()">üé®</button>
  <button onclick="resetChat()">RESET</button>
</div>

<script src="https://js.puter.com/v2/"></script>

<script>
const chatDiv = document.getElementById("chat");
const input = document.getElementById("msg");

const systemPrompt = {
  role: "system",
  content: `
Sei NapoliAI.
Parla SOLO in dialetto napoletano stretto.
Ricorda quello che dice l‚Äôutente.
Sii amichevole, ironico e coerente.
`
};

// MEMORIA LUNGA
let conversation = JSON.parse(localStorage.getItem("napolia_memory")) || [systemPrompt];

function saveMemory() {
  localStorage.setItem("napolia_memory", JSON.stringify(conversation));
}

function renderChat() {
  chatDiv.innerHTML = "";
  conversation.forEach(m => {
    if (m.role === "system") return;
    const div = document.createElement("div");
    div.className = "msg " + (m.role === "user" ? "user" : "ai");
    div.innerHTML = m.content;
    chatDiv.appendChild(div);
  });
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

renderChat();

async function send() {
  const text = input.value.trim();
  if (!text) return;
  input.value = "";

  conversation.push({ role: "user", content: text });
  renderChat();
  saveMemory();

  const aiDiv = document.createElement("div");
  aiDiv.className = "msg ai";
  chatDiv.appendChild(aiDiv);

  const response = await puter.ai.chat(
    conversation,
    { model: "gpt-5-nano", stream: true }
  );

  for await (const part of response) {
    if (part?.text) {
      aiDiv.innerHTML += part.text;
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }
  }

  conversation.push({ role: "assistant", content: aiDiv.innerHTML });
  saveMemory();
}

async function sendImage() {
  const prompt = input.value.trim();
  if (!prompt) return;
  input.value = "";

  const style = document.getElementById("style").value;
  const styles = {
    realistic: "ultra realistic photography, 8k",
    cartoon: "cartoon illustration, vibrant colors",
    anime: "anime style, studio ghibli"
  };

  const finalPrompt = `${prompt}, ${styles[style]}`;

  conversation.push({ role: "user", content: "üé® " + prompt });
  renderChat();
  saveMemory();

  const imgDiv = document.createElement("div");
  imgDiv.className = "msg ai";
  imgDiv.innerHTML = `
    üé® Sto crianno 'a figura...
    <div class="progress">
      <div class="progress-bar" id="bar"></div>
    </div>
    <div id="percent">0%</div>
  `;
  chatDiv.appendChild(imgDiv);

  // PROGRESSO VISIVO
  let percent = 0;
  const bar = imgDiv.querySelector("#bar");
  const percentTxt = imgDiv.querySelector("#percent");

  const timer = setInterval(() => {
    if (percent < 95) {
      percent += 5;
      bar.style.width = percent + "%";
      percentTxt.innerText = percent + "%";
    }
  }, 300);

  try {
    const res = await fetch("/.netlify/functions/image", {
      method: "POST",
      body: JSON.stringify({ prompt: finalPrompt })
    });

    const data = await res.json();
    clearInterval(timer);

    bar.style.width = "100%";
    percentTxt.innerText = "100%";

    imgDiv.innerHTML = `
      <div>üñºÔ∏è ${prompt}</div>
      <img src="${data.image}">
    `;

    conversation.push({ role: "assistant", content: imgDiv.innerHTML });
    saveMemory();

    // COMMENTO NAPOLIAI
    const commentDiv = document.createElement("div");
    commentDiv.className = "msg ai";
    chatDiv.appendChild(commentDiv);

    const comment = await puter.ai.chat(
      [
        { role: "system", content: "Commenta l'immagine in napoletano stretto." },
        { role: "user", content: prompt }
      ],
      { model: "gpt-5-nano", stream: true }
    );

    for await (const part of comment) {
      if (part?.text) {
        commentDiv.innerHTML += part.text;
      }
    }

    conversation.push({ role: "assistant", content: commentDiv.innerHTML });
    saveMemory();

  } catch {
    imgDiv.innerHTML = "‚ö†Ô∏è Nun riesco a fa 'a figura üò¢";
  }
}

function resetChat() {
  if (confirm("Vu√≤ cancell√† tutta 'a memoria?")) {
    conversation = [systemPrompt];
    saveMemory();
    renderChat();
  }
}

input.addEventListener("keypress", e => {
  if (e.key === "Enter") send();
});
</script>

</body>
</html>
