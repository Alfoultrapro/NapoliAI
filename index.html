<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>NapoliAI</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #cce6ff;
  margin: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

h1 {
  background: #004080;
  color: white;
  padding: 25px;
  margin: 0;
  text-align: center;
  font-size: 2.8em;
}

.chat-wrapper {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.msg {
  max-width: 75%;
  padding: 18px 24px;
  margin-bottom: 15px;
  border-radius: 25px;
  font-size: 1.6em;
  line-height: 1.6em;
  word-wrap: break-word;
}

.user {
  background: #99ccff;
  color: #004080;
  align-self: flex-end;
  border-bottom-right-radius: 0;
}

.ai {
  background: #004080;
  color: white;
  align-self: flex-start;
  border-bottom-left-radius: 0;
}

.msg img {
  max-width: 100%;
  border-radius: 20px;
  margin-top: 10px;
}

.input-area {
  display: flex;
  gap: 10px;
  padding: 12px;
  border-top: 2px solid #004080;
  background: #cce6ff;
}

.input-area input {
  flex: 1;
  padding: 20px;
  font-size: 1.5em;
  border-radius: 30px;
  border: 2px solid #004080;
}

.input-area button {
  padding: 18px 26px;
  font-size: 1.5em;
  border-radius: 30px;
  border: none;
  background: #004080;
  color: white;
  cursor: pointer;
}

footer {
  text-align: center;
  color: #004080;
  padding: 6px;
}

@media (max-width:600px) {
  .msg { font-size: 1.4em; max-width: 85%; }
  h1 { font-size: 2.2em; }
}
</style>
</head>

<body>

<h1>NapoliAI</h1>

<div class="chat-wrapper" id="chat"></div>

<div class="input-area">
  <input id="msg" placeholder="Scrivi o descrivi 'a figura...">
  <button onclick="send()">Invia</button>
  <button onclick="sendImage()">üé®</button>
  <button onclick="resetChat()">RESET</button>
</div>

<footer>NapoliAI - fatto da Alfonso Elefante</footer>

<script src="https://js.puter.com/v2/"></script>

<script>
const chatDiv = document.getElementById("chat");
const input = document.getElementById("msg");

const systemPrompt = {
  role: "system",
  content: "Sei NapoliAI. Parla SOLO in dialetto napoletano stretto. Nun usare italiano. Usa emoji e tono simpatico."
};

let conversation = JSON.parse(localStorage.getItem("napolia_conversation")) || [systemPrompt];

function renderChat() {
  chatDiv.innerHTML = "";
  for (let msg of conversation) {
    if (msg.role === "system") continue;
    const div = document.createElement("div");
    div.className = "msg " + (msg.role === "user" ? "user" : "ai");
    div.innerHTML = msg.content;
    chatDiv.appendChild(div);
  }
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

renderChat();

function saveConversation() {
  localStorage.setItem("napolia_conversation", JSON.stringify(conversation));
}

async function send() {
  const text = input.value.trim();
  if (!text) return;
  input.value = "";

  conversation.push({ role: "user", content: text });
  renderChat();
  saveConversation();

  const aiDiv = document.createElement("div");
  aiDiv.className = "msg ai";
  chatDiv.appendChild(aiDiv);

  try {
    const response = await puter.ai.chat(
      [systemPrompt, ...conversation.filter(m => m.role !== "system")],
      { model: "gpt-5-nano", stream: true }
    );

    for await (const part of response) {
      if (part?.text) {
        aiDiv.innerHTML += part.text;
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }
    }

    conversation.push({ role: "assistant", content: aiDiv.innerHTML });
    saveConversation();

  } catch (e) {
    aiDiv.innerHTML = "‚ö†Ô∏è Aggio avuto nu problema üò¢";
  }
}

async function sendImage() {
  const prompt = input.value.trim();
  if (!prompt) return;
  input.value = "";

  conversation.push({ role: "user", content: "üé® " + prompt });
  renderChat();
  saveConversation();

  const imgDiv = document.createElement("div");
  imgDiv.className = "msg ai";
  imgDiv.innerHTML = "üé® Sto facenno 'a magia...";
  chatDiv.appendChild(imgDiv);
  chatDiv.scrollTop = chatDiv.scrollHeight;

  try {
    const img = await puter.ai.image(prompt, { size: "1024x1024" });

    imgDiv.innerHTML = `
      <div>üñºÔ∏è ${prompt}</div>
      <img src="${img.url}">
    `;

    conversation.push({ role: "assistant", content: imgDiv.innerHTML });
    saveConversation();

  } catch (e) {
    imgDiv.innerHTML = "‚ö†Ô∏è Nun riesco a fa 'a figura üò¢";
  }
}

function resetChat() {
  if (confirm("Vu√≤ cancell√† tutta 'a chat?")) {
    conversation = [systemPrompt];
    localStorage.removeItem("napolia_conversation");
    renderChat();
  }
}

input.addEventListener("keypress", e => {
  if (e.key === "Enter") send();
});
</script>

</body>
</html>
